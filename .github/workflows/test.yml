name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: apps/web
        run: bun install --frozen-lockfile

      - name: Run ESLint
        working-directory: apps/web
        run: bun run lint

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: apps/web
        run: bun install --frozen-lockfile

      - name: Run unit tests
        working-directory: apps/web
        run: bun run test

      - name: Run unit tests with coverage
        working-directory: apps/web
        run: bun run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        # Don't fail CI on Codecov upload issues (external service)
        continue-on-error: true
        with:
          files: apps/web/coverage/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: apps/web/coverage/
          retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: apps/web
        run: bun install --frozen-lockfile

      - name: Build
        working-directory: apps/web
        run: bun run build

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: apps/web
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: apps/web
        run: bunx playwright install --with-deps chromium

      - name: Run E2E tests (Chrome only for CI)
        working-directory: apps/web
        run: bunx playwright test --project=desktop-chrome
        env:
          BASE_URL: https://brennerbot.org

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 7

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: apps/web/test-results/
          retention-days: 7

  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: apps/web
        run: bun install --frozen-lockfile

      - name: TypeScript check
        working-directory: apps/web
        run: bunx tsc --noEmit

  cli-tests:
    name: CLI Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies (apps/web)
        working-directory: apps/web
        run: bun install --frozen-lockfile

      - name: Run CLI tests
        run: bun test brenner.test.ts

  brenner-compile:
    name: Brenner Compile (standalone)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies (apps/web)
        working-directory: apps/web
        run: bun install --frozen-lockfile

      - name: Compile brenner
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          BRENNER_VERSION="0.0.0-ci" \
            BRENNER_GIT_SHA="${GITHUB_SHA}" \
            BRENNER_BUILD_DATE="${BUILD_DATE}" \
            BRENNER_TARGET="linux-x64" \
            bun build --compile --minify --env=BRENNER_* \
              --target=bun-linux-x64-baseline --outfile dist/brenner ./brenner.ts

      - name: Run brenner smoke commands
        shell: bash
        run: |
          set -euo pipefail
          ./dist/brenner --version | grep -q "brenner 0.0.0-ci"
          ./dist/brenner help >/dev/null
          ./dist/brenner doctor --json --skip-ntm --skip-cass --skip-cm >/dev/null
          ./dist/brenner corpus search "Brenner" --docs transcript --limit 1 >/dev/null

  installer-smoke-unix:
    name: Installer Smoke (bash)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies (apps/web)
        working-directory: apps/web
        run: bun install --frozen-lockfile

      - name: Build local brenner artifact
        id: build
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p dist

          os="$(uname -s)"
          arch="$(uname -m)"

          case "$os" in
            Linux) os="linux" ;;
            Darwin) os="darwin" ;;
            *) echo "Unsupported OS: $os" >&2; exit 1 ;;
          esac

          case "$arch" in
            x86_64|amd64) arch="x64" ;;
            arm64|aarch64) arch="arm64" ;;
            *) echo "Unsupported arch: $arch" >&2; exit 1 ;;
          esac

          platform="${os}-${arch}"
          outfile="brenner-${platform}"

          target=""
          case "$platform" in
            linux-x64) target="bun-linux-x64-baseline" ;;
            linux-arm64) target="bun-linux-arm64" ;;
            darwin-x64) target="bun-darwin-x64" ;;
            darwin-arm64) target="bun-darwin-arm64" ;;
            *) : ;;
          esac

          if [[ -n "$target" ]]; then
            bun build --compile --minify --target="$target" --outfile "dist/${outfile}" ./brenner.ts
          else
            bun build --compile --minify --outfile "dist/${outfile}" ./brenner.ts
          fi

          if command -v sha256sum >/dev/null 2>&1; then
            checksum="$(sha256sum "dist/${outfile}" | awk '{print $1}')"
          else
            checksum="$(shasum -a 256 "dist/${outfile}" | awk '{print $1}')"
          fi

          echo "platform=$platform" >> "$GITHUB_OUTPUT"
          echo "artifact_path=$GITHUB_WORKSPACE/dist/${outfile}" >> "$GITHUB_OUTPUT"
          echo "checksum=$checksum" >> "$GITHUB_OUTPUT"

      - name: Run install.sh against file:// artifact
        shell: bash
        run: |
          set -euo pipefail

          export HOME="${RUNNER_TEMP}/brenner-install-home"
          export SHELL="/bin/bash"
          mkdir -p "$HOME"

          dest="$HOME/.local/bin"
          mkdir -p "$dest"

          artifact_url="file://${{ steps.build.outputs.artifact_path }}"
          checksum="${{ steps.build.outputs.checksum }}"
          log="${RUNNER_TEMP}/installer.log"

          bash ./install.sh \
            --dest "$dest" \
            --artifact-url "$artifact_url" \
            --checksum "$checksum" \
            --easy-mode \
            --verify \
            --skip-ntm --skip-cass --skip-cm 2>&1 | tee "$log"

      - name: Upload installer log (failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: installer-log-unix-${{ matrix.os }}
          path: ${{ runner.temp }}/installer.log
          retention-days: 7

  installer-smoke-windows:
    name: Installer Smoke (pwsh)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies (apps/web)
        working-directory: apps/web
        run: bun install --frozen-lockfile

      - name: Build local brenner artifact
        id: build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path dist | Out-Null

          # Build natively on Windows without --target flag
          # This avoids CDN download issues for specific Bun variants
          # Retry logic with exponential backoff for transient failures
          $maxAttempts = 3
          $attempt = 0
          $success = $false
          $delaySeconds = 5

          while (-not $success -and $attempt -lt $maxAttempts) {
            $attempt++
            Write-Host "Build attempt $attempt of $maxAttempts..."
            try {
              # Use native build (no --target) to avoid downloading specific variants
              bun build --compile --minify --outfile dist/brenner-win-x64.exe ./brenner.ts
              if ($LASTEXITCODE -eq 0 -and (Test-Path "dist/brenner-win-x64.exe")) {
                $success = $true
              } else {
                throw "Build failed or output not found"
              }
            } catch {
              Write-Host "Attempt $attempt failed: $_"
              if ($attempt -lt $maxAttempts) {
                Write-Host "Retrying in $delaySeconds seconds..."
                Start-Sleep -Seconds $delaySeconds
                $delaySeconds = $delaySeconds * 2  # Exponential backoff
              }
            }
          }

          if (-not $success) {
            throw "Failed to build after $maxAttempts attempts"
          }

          $artifactPath = (Resolve-Path "dist/brenner-win-x64.exe").Path
          $checksum = (Get-FileHash -Path $artifactPath -Algorithm SHA256).Hash

          "artifact_path=$artifactPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "checksum=$checksum" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Run install.ps1 against file:// artifact
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $dest = Join-Path $env:RUNNER_TEMP "brenner-bin"
          New-Item -ItemType Directory -Force -Path $dest | Out-Null

          $artifactPath = "${{ steps.build.outputs.artifact_path }}"
          $artifactUrl = (New-Object System.Uri($artifactPath)).AbsoluteUri
          $checksum = "${{ steps.build.outputs.checksum }}"

          $log = Join-Path $env:RUNNER_TEMP "installer.log"
          Start-Transcript -Path $log -Force | Out-Null
          try {
            & .\install.ps1 -Dest $dest -ArtifactUrl $artifactUrl -Checksum $checksum -EasyMode -Verify -SkipNtm -SkipCass -SkipCm
            if ($LASTEXITCODE -ne 0) { throw "Installer exit code: $LASTEXITCODE" }
            & (Join-Path $dest "brenner.exe") doctor --json --skip-ntm --skip-cass --skip-cm
            if ($LASTEXITCODE -ne 0) { throw "Doctor exit code: $LASTEXITCODE" }
          } finally {
            Stop-Transcript | Out-Null
          }

      - name: Upload installer log (failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: installer-log-windows
          path: ${{ runner.temp }}/installer.log
          retention-days: 7

  installer-lint-bash:
    name: Installer Lint (install.sh)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: bash -n
        run: bash -n install.sh

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: shellcheck
        run: shellcheck install.sh

  installer-lint-pwsh:
    name: Installer Lint (install.ps1)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"
          Install-Module -Name PSScriptAnalyzer -Scope CurrentUser -Force -AllowClobber

      - name: PSScriptAnalyzer (Error severity)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $results = Invoke-ScriptAnalyzer -Path ./install.ps1 -Severity Error
          if ($results) {
            $results | Format-Table -AutoSize | Out-String | Write-Host
            throw "PSScriptAnalyzer found $($results.Count) error(s)."
          }

  toolchain-manifest-check:
    name: Toolchain Manifest Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies (apps/web)
        working-directory: apps/web
        run: bun install --frozen-lockfile

      - name: Render install plan (all platforms)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x ./brenner.ts

          ./brenner.ts toolchain plan --manifest specs/toolchain.manifest.json --platform linux-x64 --json >/dev/null
          ./brenner.ts toolchain plan --manifest specs/toolchain.manifest.json --platform linux-arm64 --json >/dev/null
          ./brenner.ts toolchain plan --manifest specs/toolchain.manifest.json --platform darwin-arm64 --json >/dev/null
          ./brenner.ts toolchain plan --manifest specs/toolchain.manifest.json --platform darwin-x64 --json >/dev/null
          ./brenner.ts toolchain plan --manifest specs/toolchain.manifest.json --platform win-x64 --json >/dev/null

  ubs-scan:
    name: UBS Scan (changed JS/TS files)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install UBS
        shell: bash
        run: |
          set -euo pipefail

          install_dir="$HOME/.local/bin"
          mkdir -p "$install_dir"
          echo "$install_dir" >> "$GITHUB_PATH"

          curl -fsSL "https://raw.githubusercontent.com/Dicklesworthstone/ultimate_bug_scanner/master/install.sh" \
            | bash -s -- \
              --non-interactive \
              --skip-hooks \
              --no-path-modify \
              --skip-doctor \
              --skip-version-check \
              --install-dir "$install_dir"

      - name: Prepare UBS workspace (changed files only)
        id: ubs
        shell: bash
        run: |
          set -euo pipefail

          base=""
          head="${GITHUB_SHA}"

          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            base="${{ github.event.pull_request.base.sha }}"
          elif [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            base="${{ github.event.before }}"
          fi

          if [[ -z "$base" || "$base" == "0000000000000000000000000000000000000000" ]]; then
            echo "No base SHA available; skipping UBS."
            echo "file_count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          mapfile -t all_files < <(git diff --name-only "$base" "$head" | sort -u)
          files=()
          for f in "${all_files[@]}"; do
            case "$f" in
              *.ts|*.tsx|*.js|*.jsx) files+=("$f") ;;
              *) : ;;
            esac
          done
          echo "Found ${#files[@]} changed JS/TS file(s)."

          if [[ "${#files[@]}" -eq 0 ]]; then
            echo "file_count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          workdir="$(mktemp -d "${RUNNER_TEMP}/ubs-changed.XXXXXX")"

          copied=0
          for f in "${files[@]}"; do
            if [[ ! -f "$f" ]]; then
              continue
            fi

            mkdir -p "$workdir/$(dirname "$f")"
            cp "$f" "$workdir/$f"
            copied=$((copied + 1))
          done

          echo "workdir=$workdir" >> "$GITHUB_OUTPUT"
          echo "file_count=$copied" >> "$GITHUB_OUTPUT"
          echo "UBS workspace: $workdir (files: $copied)"

      - name: Run UBS (fail on critical only)
        if: ${{ steps.ubs.outputs.file_count != '0' }}
        shell: bash
        run: |
          set -euo pipefail
          # Run UBS in CI mode, fail only on critical issues (not warnings)
          # Warnings are still displayed for visibility but don't block the build
          ubs --only=js --ci "${{ steps.ubs.outputs.workdir }}"
